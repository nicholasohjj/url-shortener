@startuml URL Shortener - Redirect Sequence

!theme plain

title Redirect Short URL - Sequence Diagram

actor User
participant "Browser" as Browser
participant "Route Handler\n/[slug]" as Handler
participant "Prisma ORM" as Prisma
database "PostgreSQL" as DB

User -> Browser: Click short URL\nor navigate to /[slug]
Browser -> Handler: GET /[slug]

Handler -> Prisma: findUnique({ slug })
Prisma -> DB: SELECT * FROM ShortUrl\nWHERE slug = ?\nLIMIT 1
DB --> Prisma: ShortUrl record or null
Prisma --> Handler: ShortUrl object or null

alt Short URL not found
    Handler --> Browser: 404 Not Found\n{error: "Short URL not found"}
    Browser --> User: Display 404 error
else Short URL found
    Handler -> Handler: Start async click tracking\n(fire-and-forget)
    
    par Async Click Tracking (non-blocking)
        Handler -> Prisma: update({ slug })\n{clicks: increment(1),\nlastAccessedAt: now()}
        Prisma -> DB: UPDATE ShortUrl\nSET clicks = clicks + 1,\nlastAccessedAt = NOW()\nWHERE slug = ?
        DB --> Prisma: Updated record
        Prisma --> Handler: Success (ignored)
    end
    
    Handler --> Browser: 302 Found\nLocation: targetUrl
    Browser -> Browser: Follow redirect
    Browser --> User: Navigate to target URL
end

note right of Handler
  Click tracking is performed
  asynchronously to ensure
  instant redirects. Errors
  in tracking don't block
  the redirect.
end note

@enduml

